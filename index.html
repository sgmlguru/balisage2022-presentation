<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Migrating DocBook to Uncharted Waters</title>

		<link rel="stylesheet" href="../reveal.js/dist/reset.css">
		<link rel="stylesheet" href="../reveal.js/dist/reveal.css">
		<link rel="stylesheet" href="../reveal.js/dist/theme/black.css">
		
		<!--<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/black.css">-->

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="../reveal.js/plugin/highlight/monokai.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				
				<!-- Cover Slide -->
				<section>
					<section>
						<h1>Migrating DocBook to Uncharted Waters</h1>
						<h5>ari.nordstrom@gmail.com</h5>
						
					</section>
				</section>
				
				
				<!-- Intro -->
				<section>
					<section>
						<h3>Intro</h3>
						
						<img src="img/docbook-logo.png" alt="DocBook logo"/>
						
						<aside class="notes">
							<p></p>
						</aside>
					</section>
					
					<section>
						<h5>This Should Be Easy...</h5>
						
						<ol>
							<li>Clean up and convert DocBook 4.0 to 4.3</li>
							<li>Convert the DocBook 4.3 to (X)HTML</li>
						</ol>
						
						<aside class="notes">
							<p><q>Pipelines!</q></p>
						</aside>
					</section>
					
					<section>
						<h5>Sources</h5>
						
						<!-- A few points about DB4.0, XIncludes, etc -->
						<!-- Books of varying sizes -->
						<!-- Some reference works, some diagnostic tess -->
						<!-- Split into fragments down to Q&A level -->
						<!-- "Bursted" XIncludes -->
					</section>
					
					<section>
						<h5>4.0 to 4.3?</h5>
						
						<p>UTF-8 encoding, really, plus a few tweaks</p>
					</section>
					
					<section>
						<h5>4.3 to HTML?</h5>
						
						<ul>
							<li>Pass through (a lot of) Math ML</li>
							<li>Insert metadata for publishing</li>
							<li>Oh, and an HTML conversion</li>
						</ul>
					</section>
					
					<section>
						<h5>Pipelines?</h5>
						
						<!-- XSLT manifest example -->
						<pre class="xml">
							<code data-trim data-noescape><?xml version="1.0" encoding="UTF-8"?>
&lt;manifest
    xmlns=&quot;http://www.corbas.co.uk/ns/transforms/manifest&quot;
    xml:base=&quot;.&quot;&gt;
    
    &lt;group
        description=&quot;An example XSLT pipeline manifest&quot;
        xml:base=&quot;../xslt/&quot;&gt;
        &lt;item href=&quot;step1.xsl&quot; description=&quot;To element one&quot;&gt;
            &lt;meta name=&quot;param1&quot; value=&quot;value1&quot;/&gt;
        &lt;/item&gt;
        &lt;item href=&quot;step2.xsl&quot; description=&quot;To element two&quot;/&gt;
        &lt;item href=&quot;step3.xsl&quot; description=&quot;To element three&quot;&gt;
            &lt;meta name=&quot;param3A&quot; value=&quot;value3A&quot;/&gt;
            &lt;meta name=&quot;param3B&quot; value=&quot;value3B&quot;/&gt;
        &lt;/item&gt;
        &lt;item href=&quot;step4.xsl&quot; description=&quot;To element four&quot;/&gt;
    &lt;/group&gt;
    
&lt;/manifest&gt;
</code>
						</pre>
						
						<aside class="notes">
							<p>XSLTs run in sequence, output from 1 input to 2, etc</p>
							<p>They all do ONE thing</p>
							<p>Interested parties, see Balisage 2020 paper</p>
							<p>XProc 3.0 implementation out now!</p>
						</aside>
					</section>
					
					<section>
						<h5>Again, Easy. Right?</h5>
					</section>
					
				</section>
				
				
				<section>
					<section>
						<h3>Cleanup</h3>
					</section>
					
					<section>
						<h5>Game Plan</h5>
						
						<ol>
							<li class="fragment">Normalise</li>
							<li class="fragment">Tweak</li>
							<li class="fragment">Encode</li>
						</ol>
						
						<aside class="notes">
							<p>The content is in fragments, remember?</p>
							<p>Some minor tweaks as listed by the client</p>
							<p>4.0 to 4.3 is really just a new DOCTYPE</p>
							<p>We need UTF-8</p>
						</aside>
					</section>
					
					<section>
						<h5>Normalisation</h5>
						
						<p>Pull in all <code>XInclude</code> links</p>
						<pre class="xml">
							<code data-trim data-noescape>&lt;xi:include href="section1.xml"/></code>
						</pre>
						
						<p>List XInclude targets in an exclude filter:</p>
						<pre class="xml">
							<code data-trim data-noescape>&lt;p:option
    name=&quot;exclude-filter&quot;
    select=&quot;&apos;(section1.xml|section2.xml|section3.xml)&apos;&quot;/&gt;</code>
						</pre>
						
						<!-- Pull in XInclude targets -->
						<!-- List all XInclude targets -->
						<!-- Add those to exclude filter (to not process them once pulled in) -->
						<!-- Here's where I spotted the first issue -->
						
						<aside class="notes">
							<p>exclude-filter to not continue processing normalised XInclude fragments</p>
							<p>And here was the first issue</p>
						</aside>
					</section>
					
					<section>
						<h5>Windchill File Protocol</h5>
						
						<pre class="xml">
							<code data-trim data-noescape>x-wc://file=0000079863.xml</code>
						</pre>
						
						<p>Easy enough to fix, but then I discovered <em>why</em></p>
						
						<!-- Properietary file protocol -->
						<!-- Easy enough to fix, but then I discovered WHY -->
					</section>
					
					<section>
						<h5>File Naming</h5>
						
						<pre class="xml">
							<code data-trim data-noescape>01234.xml
My filename.xml
Multiple   whitespaces  in filenames.xml
Ampersands? Yes & No.xml
Square brackets [2].xml
...</code>
						</pre>
						
						<p class="fragment">Exclude filters are <em>regular expressions</em></p>
						
						<!-- Files actually used ANY characters, including... -->
						<!-- Multiple spaces -->
						<!-- Ampersands -->
						<!-- Square brackets... -->
						<!-- Exclude Filters Are Regular Expressions! -->
						
						<aside class="notes">
							<p>The protocol is to allow ANY filenames</p>
							<p>When doing a burst, the system uses the fragment title name</p>
						</aside>
					</section>
					
					<section>
						<h5>File Renaming Step</h5>
						
						<pre class="xml">
							<code data-trim data-noescape>&lt;sg:rename name=&quot;rename&quot;&gt;
    &lt;p:with-option name=&quot;input-dir&quot; select=&quot;$input-base-uri&quot;/&gt;
    &lt;p:with-option name=&quot;output-dir&quot; select=&quot;concat($tmp-dir,&apos;/names-fixed&apos;)&quot;/&gt;
    &lt;p:with-option name=&quot;reports-dir&quot; select=&quot;$reports-dir&quot;/&gt;
    &lt;p:with-option name=&quot;tmp-dir&quot; select=&quot;$tmp-dir&quot;/&gt;
&lt;/sg:rename&gt;</code>
						</pre>
						
						<ul>
							<li class="fragment">Rename files</li>
							<li class="fragment">Rename XInclude hrefs</li>
						</ul>
						
						<!-- Filenames can be fixed... -->
						<!-- ...but then the hrefs to them also must be! -->
						<!-- XProc step for reliable file renaming for both files and hrefs -->
						
						<!-- Figure: tree command output for the renaming step before/after folders? -->
						
						<aside class="notes">
							<p>Renaming the easier option</p>
							<p>The key is reliability</p>
						</aside>
					</section>
					
					<section>
						<h5>Unicode and UTF-8</h5>
						
						<p>All we need is...</p>
						<pre class="xml">
							<code data-trim data-noescape>&lt;xsl:output method="xml" indent="yes" encoding="UTF-8"/></code>
						</pre>
						
						<p>Provided we have...</p>
						<pre class="xml">
							<code data-trim data-noescape>&lt;!DOCTYPE set PUBLIC &quot;-//Arbortext//DTD DocBook XML V4.0 + MathML//EN&quot;
 &quot;axdocbook_math.dtd&quot;&gt;</code>
						</pre>
						
						<!-- All we need is an ID transform serialised as UTF-8 -->
						<!-- Provided we have all the character entiry declarations -->
						<!-- And working DTDs -->
						<!-- ...and proper DOCTYPE declarations -->
					</section>
					
					<section>
						<h5>Remember Those XIncludes</h5>
						
						<!-- Code examples with outcommented DOCTYPEs -->
						
						<pre class="xml">
							<code data-trim data-noescape>&lt;!-- Fragment document type declaration subset:
Arbortext, Inc., 1988-2017, v.4002
&lt;!DOCTYPE set PUBLIC &quot;-//Arbortext//DTD DocBook XML V4.0 + MathML//EN&quot;
 &quot;axdocbook_math.dtd&quot;&gt;
--&gt;
&lt;?Pub EntList alpha bull copy rArr sect trade ordm ohm mu j0 omega
eacute?&gt;
&lt;?Pub Inc?&gt;
&lt;section id=&quot;sectionFEBB4816&quot; vendor=&quot;0000081446&quot;&gt;
    ...
&lt;/section&gt;</code>
						</pre>
						
						<!--<pre class="xml">
							<code data-trim data-noescape></code>
						</pre>-->
						
						<aside class="notes">
							<p>Can't do the ID transform without DOCTYPE</p>
							<p>Multiple variants</p>
							<p>Regexes not feasible</p>
						</aside>
					</section>
					
					<section>
						<h5>TagSoup</h5>
						
						<img src="img/tagsoup-homepage.png" alt="Tagsoup homepage" style="width: 50%"/>
						
						<!-- What it does -->
						<!-- Adds custom DOCTYPE (and html namespace, but that's easy to fix) -->
						<!-- Plus introduced Ant -->
					</section>
					
					<section>
						<h5>Add DOCTYPE</h5>
						
						<pre class="xml">
							<code data-trim data-noescape>&lt;java
    jar=&quot;lib/tagsoup-1.2.1.jar&quot;
    fork=&quot;true&quot;
    output=&quot;${base.intermediate}/${local.path}&quot;
    error=&quot;${base.reports}/err.txt&quot;&gt;
    &lt;arg value=&quot;--doctype-public=-//Arbortext//DTD DocBook XML V4.0 + MathML//EN&quot;/&gt;
    &lt;arg value=&quot;--doctype-system=axdocbook_math.dtd&quot;/&gt;
    &lt;arg value=&quot;--lexical&quot;/&gt;
    &lt;arg value=&quot;${local.file}&quot;/&gt;
&lt;/java&gt;</code>
						</pre>
						
						<aside class="notes">
							<p>Add custom DOCTYPE</p>
							<p>TagSoup foced me to add Ant on top of XProc</p>
						</aside>
					</section>
					
					<section>
						<h5>Except</h5>
						
						<!-- The client said that I don't have to normalise XIncludes here -->
						
						<aside class="notes">
							<p>Client: no need to normalise XIncludes here</p>
						</aside>
					</section>
					
					<!-- Need more on cleanup? Maybe mention of other fixes? -->
				</section>
				
				
				<!-- DB 4.3 to HTML -->
				<section>
					<section>
						<h3>DocBook to HTM PreprocessingL</h3>
					</section>
					
					<section>
						<h5>Initial Game Plan</h5>
						
						<!-- XProc pipeline to do initial fixes (i.e. metadata) and run OTB DB to HTML -->
						<!-- Use DB XSLT 1.0 package? No fun! -->
						<!-- xslTNG new and exciting, plus XSLT 3.0 -->
						<!-- How hard can it be? -->
					</section>
					
					<section>
						<h5>Remember Those XIncludes, Pt 2</h5>
						
						<!-- Due to different reqs depending on book type, different metadata usage -->
						<!-- No way to find out proper context when processing XInclude fragments -->
						<!-- We have to normalise after all -->
					</section>
					
					<section>
						<h5>Breaking Up Is Never Easy</h5>
						
						<!-- Turns out the 4.0 XI fragments weren't always correct -->
						<!-- Normalise, then insert split markup (split=true) -->
						<!-- Context and book type decide split, not just element -->
						
						<aside class="notes">
							<p>This eventually became four XSLT steps</p>
							<p>Hack: book type determined by (part of) folder name</p>
						</aside>
					</section>
					
					<section>
						<h5>Metadata Inserts</h5>
						
						<!-- Examples of metadata in context (multiple slides?) -->
						<!-- BUT: metadata insert depended on context (split, type of book) -->
						<!-- 7 steps dealt with metadata -->
					</section>
					
					<section>
						<h5>Various Tweaks</h5>
						
						<!-- Footnotes -->
						<!-- xref labels -->
						<!-- Some grouping -->
						<!-- But also... -->
					</section>
					
					<section>
						<h5>Preconverting</h5>
						
						<!-- Turns out it's sometimes easier to preconvert -->
						<!-- Some QA constructs requiring metadata alongside multiple-answer lists -->
						<!-- Insert processing attr keep=true (current node but not descendants) -->
						<!-- keep=copy (current node AND descendants) -->
					</section>
					
					<section>
						<h5>For example...</h5>
						
						<!-- Examples where pre-convert makes sense -->
					</section>
					
					<section>
						<h5>Output</h5>
						
						<!-- The preprocessing XSLT manifest's output is a normalised DocBook-ish file -->
						<!-- That is split into fragments based on the initial preprocessing -->
						<!-- Fragments were also named during preprocessing (extra attrs) -->
					</section>
				</section>
				
				
				<!-- xslTNG -->
				<section>
					<section>
						<h3>xslTNG</h3>
					</section>
					
					<section>
						<h5>In Theory</h5>
						
						<!-- Create an entry XSLT and link to docbook.xsl -->
						<!-- Do your tweaks in the entry module -->
						<!-- Run against the split output -->
					</section>
					
					<section>
						<h5>In Practice</h5>
						
						<!-- DB 4.3 doesn't live in a namespace but the expected xslTNG input does -->
						<!-- xslTNG produces a default output -->
						<!-- It's endlessly customisable (easily, too), but not always obviously so -->
						<!-- Hence more and more preconverting -->
					</section>
					
					<section>
						<h5>But Also</h5>
						
						<!-- Post-xslTNG files needed a few tweaks -->
						<!-- HTML wrappers sometimes went missing and I couldn't understand why -->
						<!-- Easier to do a combination of preconverting and postprocessing -->
						<!-- Various late-breaking reqs from client easier to do in postprocess -->
					</section>
				</section>
				
				
				<!-- Closing -->
				<section>
					<section>
						<h3></h3>
					</section>
					
					<section>
						<h5></h5>
						
						<aside class="notes">
						</aside>
					</section>
					
					
				</section>
				
				
				
				
			</div>
		</div>

		<script src="../reveal.js/dist/reveal.js"></script>
		<script src="../reveal.js/plugin/notes/notes.js"></script>
		<script src="../reveal.js/plugin/markdown/markdown.js"></script>
		<script src="../reveal.js/plugin/highlight/highlight.js"></script>
		<script src="../reveal.js/plugin/zoom/zoom.js"></script>
		
		<!--<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script src="plugin/zoom/zoom.js"></script>-->
		
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealZoom ]
			});
		</script>
	</body>
</html>
